@page "/ComparePage"
<script type="text/javascript">
        window.playClickSound = () => {
        const audio = new Audio('Assets/ShortFirework.wav');
        audio.play();
    };
</script>

@if (IsLoading)
{
    <div class="loading-overlay">
        <div class="loader"></div>
    </div>
}

<div class="row p-3">
    <div class="col">
        <span><b><i>Comparing two Disney characters is like judging a singing teapot against a sword-fighting raccoon — completely unfair, but wildly entertaining.</i></b></span>
    </div>
</div>
<div class="row g-1">
    <div class="col-12 col-md">
        <span><img src="Assets/StitchOne.jpg" style="height: 70px; width: auto;" /> Choose a Character from the dropdown or search</span>
        <div class="row pb-2">
            <div class="col">
                <select class="form-control" @onchange="OnSelectedItemChanged">
                    @foreach (var item in AllCharacters)
                    {
                        <option value="@item._id" selected="@(item == SelectedItem)">@item.name</option>
                    }
                </select>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <input class="form-control" placeholder="Search character" @bind=CharacterSearchOne />
            </div>
            <div class="col-auto">
                <button class="form-control" @onclick=SearchCharacterOne>Search</button>
            </div>
        </div>
        @if (ShowErrorMessage)
        {
            <span style="color: #D3D3D3"><b>@ErrorMessage</b></span>
        }
    </div>
    <div class="col-12 col-md">
        <span><img src="Assets/StitchTwo.jpg" style="height: 70px; width: auto;" />Choose a Character from the dropdown or search</span>
        <div class="row pb-2">
            <div class="col">
                <select class="form-control" @onchange="OnSelectedItemChanged2">
                    @foreach (var item in AllCharacters)
                    {
                        <option value="@item._id" selected="@(item == SelectedItem2)">@item.name</option>
                    }
                </select>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <input class="form-control" placeholder="Search character" @bind=CharacterSearchTwo />
            </div>
            <div class="col-auto">
                <button class="form-control" @onclick=SearchCharacterTwo>Search</button>
            </div>
        </div>
        @if (ShowErrorMessageTwo)
        {
            <span style="color: #D3D3D3"><b>@ErrorMessageTwo</b></span>
        }
    </div>
</div>
<div class="row d-flex p-2">
    <div class="col align-content-center">
        @if (SelectedItem != null && SelectedItem._id > 0)
        {
            <div class="row text-center pt-3">
                <div class="col">
                    @if (string.IsNullOrEmpty(SelectedItem.imageUrl))
                    {
                        <img src="Assets/StitchNoImage.png" style="height: 100%; width: auto" />
                    }
                    else
                    {
                        <img src="@SelectedItem.imageUrl" style="height: 100%; width: auto" />
                    }
                </div>
            </div>
        }
    </div>
    <div class="col align-content-center">
        @if (SelectedItem2 != null && SelectedItem2._id > 0)
        {
            <div class="row text-center pt-3">
                <div class="col">
                    @if (string.IsNullOrEmpty(SelectedItem2.imageUrl))
                    {
                        <img src="Assets/StitchNoImage.png" style="height: 100%; width: auto" />
                    }
                    else
                    {
                        <img src="@SelectedItem2.imageUrl" style="height: 100%; width: auto" />
                    }
                </div>
            </div>
        }
    </div>
</div>
<div class="row pb-2">
    <div class="col">
        <FilmsComponent SelectedItem="SelectedItem" WinCategory="WinnerDinner.FirstOrDefault(wd => wd.Item3 == CharacterProperty.Films).Item2"></FilmsComponent>
    </div>
    <div class="col">
        <FilmsComponent SelectedItem="SelectedItem2" WinCategory="WinnerDinner2.FirstOrDefault(wd => wd.Item3 == CharacterProperty.Films).Item2"></FilmsComponent>
    </div>
</div>
<div class="row pb-2">
    <div class="col">
        <ShortFilmsComponent SelectedItem="SelectedItem" WinCategory="WinnerDinner.FirstOrDefault(wd => wd.Item3 == CharacterProperty.ShortFilms).Item2"></ShortFilmsComponent>
    </div>
    <div class="col">
        <ShortFilmsComponent SelectedItem="SelectedItem2" WinCategory="WinnerDinner2.FirstOrDefault(wd => wd.Item3 == CharacterProperty.ShortFilms).Item2"></ShortFilmsComponent>
    </div>
</div>
<div class="row pb-2">
    <div class="col">
        <TVShowsComponent SelectedItem="SelectedItem" WinCategory="WinnerDinner.FirstOrDefault(wd => wd.Item3 == CharacterProperty.TVShows).Item2"></TVShowsComponent>
    </div>
    <div class="col">
        <TVShowsComponent SelectedItem="SelectedItem2" WinCategory="WinnerDinner2.FirstOrDefault(wd => wd.Item3 == CharacterProperty.TVShows).Item2"></TVShowsComponent>
    </div>
</div>
<div class="row pb-2">
    <div class="col">
        <VideoGamesComponent SelectedItem="SelectedItem" WinCategory="WinnerDinner.FirstOrDefault(wd => wd.Item3 == CharacterProperty.VideoGames).Item2"></VideoGamesComponent>
    </div>
    <div class="col">
        <VideoGamesComponent SelectedItem="SelectedItem2" WinCategory="WinnerDinner2.FirstOrDefault(wd => wd.Item3 == CharacterProperty.VideoGames).Item2"></VideoGamesComponent>
    </div>
</div>
<div class="row pb-2">
    <div class="col">
        <ParkAttractionsComponent SelectedItem="SelectedItem" WinCategory="WinnerDinner.FirstOrDefault(wd => wd.Item3 == CharacterProperty.ParkAttractions).Item2"></ParkAttractionsComponent>
    </div>
    <div class="col">
        <ParkAttractionsComponent SelectedItem="SelectedItem2" WinCategory="WinnerDinner2.FirstOrDefault(wd => wd.Item3 == CharacterProperty.ParkAttractions).Item2"></ParkAttractionsComponent>
    </div>
</div>
<div class="row pb-2">
    <div class="col">
        <AlliedComponent SelectedItem="SelectedItem" WinCategory="WinnerDinner.FirstOrDefault(wd => wd.Item3 == CharacterProperty.Allies).Item2"></AlliedComponent>
    </div>
    <div class="col">
        <AlliedComponent SelectedItem="SelectedItem2" WinCategory="WinnerDinner2.FirstOrDefault(wd => wd.Item3 == CharacterProperty.Allies).Item2"></AlliedComponent>
    </div>
</div>
<div class="row pb-2">
    <div class="col">
        <EnemiesComponent SelectedItem="SelectedItem" WinCategory="WinnerDinner.FirstOrDefault(wd => wd.Item3 == CharacterProperty.Enemies).Item2"></EnemiesComponent>
    </div>
    <div class="col">
        <EnemiesComponent SelectedItem="SelectedItem2" WinCategory="WinnerDinner2.FirstOrDefault(wd => wd.Item3 == CharacterProperty.Enemies).Item2"></EnemiesComponent>
    </div>
</div>
@if (SelectedItem != null && SelectedItem2 != null && !ShowDrawMessage)
{
    <div class="row pb-3">
        <div class="col-auto">
            <button class="form-control" style="background-color: #9c6e9f; color: white" @onclick="ShowWinner">@ButtonText</button>
        </div>
    </div>
}

@if (ShowDrawMessage)
{
    <div class="row p-2">
        <div class="col">
            <h3 style="color: #D3D3D3"><b>@DrawMessage</b></h3>
        </div>
    </div>
}
<div>
    <img class="bottom-right-image" src="Assets/Stitch.jpg" />
</div>

@code {
    [Parameter]
    public EventCallback<(bool, Characters)> WinnerDinnerShow { get; set; }

    public List<Characters> AllCharacters { get; set; } = new List<Characters>();
    private Characters SelectedItem;
    private Characters SelectedItem2;
    public Characters OverallWinner { get; set; } = new Characters();

    public enum CharacterProperty
    {
        Films,
        ShortFilms,
        TVShows,
        VideoGames,
        ParkAttractions,
        Allies,
        Enemies
    };
    public List<(List<string>, bool, CharacterProperty)> WinnerDinner { get; set; } = new List<(List<string>, bool, CharacterProperty)>();
    public List<(List<string>, bool, CharacterProperty)> WinnerDinner2 { get; set; } = new List<(List<string>, bool, CharacterProperty)>();

    public string CharacterSearchOne { get; set; } = string.Empty;
    public string CharacterSearchTwo { get; set; } = string.Empty;
    public bool ShowErrorMessage { get; set; } = false;
    public bool ShowErrorMessageTwo { get; set; } = false;
    public string ErrorMessage { get; set; } = string.Empty;
    public string ErrorMessageTwo { get; set; } = string.Empty;
    public string ButtonText = "Show Winner";
    private bool IsLoading = false;
    public string DrawMessage { get; set; } = "OOPS! It seems both characters are magnificent and have ended in a draw!";
    public bool ShowDrawMessage { get; set; } = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                IsLoading = true;
                await InvokeAsync(StateHasChanged);
                var APIResult = await Characters.GetAllCharacters();
                AllCharacters = APIResult.data.OrderBy(ac => ac.name).ToList();
            }
            finally
            {
                IsLoading = false;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private async void OnSelectedItemChanged(ChangeEventArgs e)
    {
        CharacterSearchOne = string.Empty;
        var ID = e.Value.ToString();
        SelectedItem = AllCharacters.Find(ch => ch._id.ToString() == ID);
        OnCharacterChanges();
        await InvokeAsync(StateHasChanged);
    }

    private async void OnSelectedItemChanged2(ChangeEventArgs e)
    {
        CharacterSearchTwo = string.Empty;
        var ID = e.Value.ToString();
        SelectedItem2 = AllCharacters.Find(ch => ch._id.ToString() == ID);
        OnCharacterChanges();
        await InvokeAsync(StateHasChanged);
    }

    public async void OnCharacterChanges()
    {
        await InvokeAsync(StateHasChanged);
        if (SelectedItem == null || SelectedItem2 == null) return;
        WinnerDinner.Clear();
        WinnerDinner2.Clear();

        CompareList(SelectedItem.films, SelectedItem2.films, CharacterProperty.Films);
        CompareList(SelectedItem.shortFilms, SelectedItem2.shortFilms, CharacterProperty.ShortFilms);
        CompareList(SelectedItem.tvShows, SelectedItem2.tvShows, CharacterProperty.TVShows);
        CompareList(SelectedItem.videoGames, SelectedItem2.videoGames, CharacterProperty.VideoGames);
        CompareList(SelectedItem.parkAttractions, SelectedItem2.parkAttractions, CharacterProperty.ParkAttractions);
        CompareList(SelectedItem.allies, SelectedItem2.allies, CharacterProperty.Allies);
        CompareList(SelectedItem.enemies, SelectedItem2.enemies, CharacterProperty.Enemies);
        CalculateOverallWinner();
        await InvokeAsync(StateHasChanged);
    }

    private void CompareList(List<string> list1, List<string> list2, CharacterProperty prop)
    {
        list1 ??= new List<string>();
        list2 ??= new List<string>();

        int count1 = list1.Count;
        int count2 = list2.Count;

        if (count1 > count2)
        {
            WinnerDinner.Add((list1, true, prop));
            WinnerDinner2.Add((list2, false, prop));
        }
        else if (count1 < count2)
        {
            WinnerDinner.Add((list1, false, prop));
            WinnerDinner2.Add((list2, true, prop));
        }
        else
        {
            WinnerDinner.Add((list1, false, prop));
            WinnerDinner2.Add((list2, false, prop));
        }
    }

    public async Task SearchCharacterOne()
    {
        var characterToSearch = AllCharacters.Where(c => !string.IsNullOrEmpty(c.name) && c.name.IndexOf(CharacterSearchOne, StringComparison.OrdinalIgnoreCase) >= 0).ToList();
        if (characterToSearch.Count > 1)
        {
            ErrorMessage = "More than one result has been found, please be more specific in the search";
            ShowErrorMessage = true;
        }
        else if (characterToSearch != null && characterToSearch.First()._id > 0)
        {
            //There are two ways to go about
            //One: API call
            var results = await Characters.GetCharacter(characterToSearch.First()._id);
            SelectedItem = results.data;
            //Two: Search in already populated list
            //SelectedItem = characterToSearch.First();

            ShowErrorMessage = false;
        }
        else
        {
            ErrorMessage = $"No character containing '{CharacterSearchOne}' has been found.";
            ShowErrorMessage = true;
        }
        OnCharacterChanges();
    }

    public async Task SearchCharacterTwo()
    {
        var characterToSearch = AllCharacters.Where(c => !string.IsNullOrEmpty(c.name) && c.name.IndexOf(CharacterSearchTwo, StringComparison.OrdinalIgnoreCase) >= 0).ToList();
        if (characterToSearch.Count > 1)
        {
            ErrorMessageTwo = "More than one result has been found, please be more specific in the search";
            ShowErrorMessage = true;
        }
        else if (characterToSearch != null && characterToSearch.First()._id > 0)
        {
            //There are two ways to go about
            //One: API call
            var results = await Characters.GetCharacter(characterToSearch.First()._id);
            SelectedItem2 = results.data;
            //Two: Search in already populated list
            //SelectedItem2 = characterToSearch.First();

            ShowErrorMessage = false;
        }
        else
        {
            ErrorMessage = $"No character containing '{CharacterSearchTwo}' has been found.";
            ShowErrorMessage = true;
        }
        OnCharacterChanges();
    }

    public async Task ShowWinner()
    {
        ButtonText = "Please wait..";
        await InvokeAsync(StateHasChanged);
        await JS.InvokeVoidAsync("playClickSound");
        await WinnerDinnerShow.InvokeAsync((true, OverallWinner));
        await InvokeAsync(StateHasChanged);
    }

    public void CalculateOverallWinner()
    {
        //For calculating more results for win instead of draw, I proritized some of the traits (TV Shows and Films)
        var counterOne = 0;
        var counterTwo = 0;
        foreach (var item in WinnerDinner)
        {
            if (item.Item2)
            {
                counterOne++;
            }
            if (item.Item3 == CharacterProperty.Films || item.Item3 == CharacterProperty.TVShows)
            {
                foreach (var subItem in item.Item1)
                {
                    counterOne++;
                }
            }
        }
        foreach (var item in WinnerDinner2)
        {
            if (item.Item2)
            {
                counterTwo++;
            }
            if (item.Item3 == CharacterProperty.Films || item.Item3 == CharacterProperty.TVShows)
            {
                foreach (var subItem in item.Item1)
                {
                    counterTwo++;
                }
            }
        }
        if (counterOne > counterTwo) OverallWinner = SelectedItem;
        else if (counterTwo > counterOne) OverallWinner = SelectedItem2;
        else ShowDrawMessage = true;
    }
}
